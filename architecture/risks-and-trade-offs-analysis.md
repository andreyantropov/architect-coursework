# Анализ рисков и компромиссов архитектуры

# ОСНОВНЫЕ РИСКИ АРХИТЕКТУРЫ

## 1. Инфраструктурный уровень

| Риск                           | Описание                                                           | Снижение                                                           |
| ------------------------------ | ------------------------------------------------------------------ | ------------------------------------------------------------------ |
| Vendor lock-in                 | Зависимость от managed-сервисов (MongoDB Atlas, RDS)               | Использовать абстракции (DAO), избегать vendor-specific API        |
| Несогласованность между ЦОДами | При катастрофе возможна потеря данных из-за асинхронной репликации | Ввести политики кворума (2/3 подтверждения) для критичных операций |

---

## 2. Сервисный уровень

| Риск                                | Описание                                                                    | Снижение                                                        |
| ----------------------------------- | --------------------------------------------------------------------------- | --------------------------------------------------------------- |
| Сложность управления микросервисами | Большое количество сервисов увеличивает сложность оркестрации и мониторинга | Использовать Kubernetes, Helm, Service Mesh                     |
| Зависимость от Event Bus            | При сбое Kafka могут быть потеряны события (например, `WorkoutCompleted`)   | Добавить механизмы retry, dead-letter queues и backup event log |

---

## 3. Уровень баз данных

| Риск                                              | Описание                                                     | Снижение                                                                               |
| ------------------------------------------------- | ------------------------------------------------------------ | -------------------------------------------------------------------------------------- |
| Несоответствие ACID в документоориентированных БД | MongoDB не гарантирует транзакционности на уровне PostgreSQL | Использовать CQRS — запись через реляционную БД, чтение через документоориентированную |
| Проблемы с колоночными запросами                  | ClickHouse плохо работает с точечными запросами              | Кэширование популярных запросов в Redis, Materialized Views                            |

---

## 4. Уровень AI/ML

| Риск                    | Описание                                                            | Снижение                                                                                                                                        |
| ----------------------- | ------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| Bias и Fairness моделей | Модели могут давать некорректные рекомендации, особенно медицинские | Проводить регулярный аудит моделей, использовать дифференциальную приватность, привлекать специалистов-людей к выборочной проверке рекомендаций |
| Cold start в Serverless | Lambda функции имеют задержку запуска, что влияет на инференс       | Provisioned concurrency, кэширование часто используемых моделей в Redis                                                                         |

---

## 5. Безопасность

| Риск                 | Описание                                                            | Снижение                                                    |
| -------------------- | ------------------------------------------------------------------- | ----------------------------------------------------------- |
| Утечка PII-данных    | Хранение персональных данных в разных регионах повышает риск утечки | Шифрование данных, разделение ключей шифрования по регионам |
| Атаки на API Gateway | Возможны DDoS-атаки на External API Gateway                         | WAF, rate limiting, Cloudflare как барьер, защита через CDN |

---

## 6. CQRS / Event Sourcing

| Риск                                           | Описание                                                             | Снижение                                                       |
| ---------------------------------------------- | -------------------------------------------------------------------- | -------------------------------------------------------------- |
| Несинхронизированное состояние чтения и записи | Read Model может быть устаревшим при задержках в обработке событий   | Использование Materialized Views или event log replay          |
| Сложность реализации replay событий            | Восстановление состояния сервиса из event log требует сложной логики | Логирование и мониторинг дельты между Command и Query моделями |

---

## 7. Гибридная архитектура (MSA + Serverless)

| Риск                                             | Описание                                             | Снижение                                                          |
| ------------------------------------------------ | ---------------------------------------------------- | ----------------------------------------------------------------- |
| Сложность управления разнородной инфраструктурой | Разные подходы к масштабированию, мониторингу, CI/CD | Единая стратегия IaC (Terraform), унифицированная метрика SLI/SLO |
| Cold start в Serverless                          | Инференс моделей может быть медленным                | Использовать provisioned concurrency, кэшировать модели в Redis   |

---

## 8. Service Mesh и оркестрация

| Риск                              | Описание                                                     | Снижение                                             |
| --------------------------------- | ------------------------------------------------------------ | ---------------------------------------------------- |
| Сложность управления Service Mesh | Istio/Linkerd добавляют операционную сложность               | Использовать OpenTelemetry + Grafana для мониторинга |
| Sidecar overhead                  | Sidecars могут вызывать задержки и потреблять много ресурсов | Автоматизация деплоя через GitOps                    |
| Политики безопасности             | Разные политики доступа могут привести к ошибкам             | Постоянный аудит политик через OPA/Gatekeeper        |

---

## 9. Multi-cloud стратегия

| Риск                                        | Описание                                                                     | Снижение                                                             |
| ------------------------------------------- | ---------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| Географическая несогласованность данных     | Разные регионы могут иметь несогласованные версии данных                     | CDN с edge-функциями, global service mesh                            |
| Vendor lock-in в части региональных решений | Управление ресурсами в разных облаках может создать частичный vendor lock-in | Использовать кросс-платформенные инструменты (Kubernetes, Terraform) |
| Сложности с сетью и маршрутизацией          | Задержки между облакми могут повлиять на производительность                  | Global load balancing, region-based routing                          |

---

## 10. Offline режим мобильного клиента

| Риск                               | Описание                                                                | Снижение                                          |
| ---------------------------------- | ----------------------------------------------------------------------- | ------------------------------------------------- |
| Конфликты данных при синхронизации | Изменения в офлайне могут конфликтовать с серверными данными            | Two-phase commit, local event log                 |
| Потеря данных при сбое устройства  | Отсутствие немедленной синхронизации может привести к потере тренировок | Локальное хранение с последующей синхронизацией   |
| Несогласованность рекомендаций     | Модель не знает о новых тренировках до sync                             | Версионирование объектов, last_modified timestamp |

---

## 11. GDPR/CCPA Compliance

| Риск                              | Описание                                                                 | Снижение                                  |
| --------------------------------- | ------------------------------------------------------------------------ | ----------------------------------------- |
| Несоблюдение права на забвение    | Трудно гарантировать удаление всех копий данных в распределённой системе | Centralized consent management            |
| Анонимизация не всегда эффективна | Возможно re-identification по метрикам тренировок                        | Differential privacy, k-anonymity         |
| Сложности управления ключами      | Разделение ключей шифрования по регионам                                 | Единая система управления ключами (Vault) |

---

## 12. A/B тестирование и аналитика

| Риск                        | Описание                                                                     | Снижение                                    |
| --------------------------- | ---------------------------------------------------------------------------- | ------------------------------------------- |
| Ошибка в сегментации        | Неправильное назначение пользователей в группы A/B может исказить результаты | Feature flags с четкой сегментацией         |
| Утечка тестовых данных      | Не все данные могут быть отделены от production                              | Логирование в отдельные таблицы             |
| Неявные байесовские эффекты | Тесты могут влиять друг на друга, если проводятся одновременно               | Аудит маркетинговых кампаний перед запуском |

---

## 13. Frontend и UX

| Риск                              | Описание                                         | Снижение                                        |
| --------------------------------- | ------------------------------------------------ | ----------------------------------------------- |
| Производительность в React Native | Может быть ниже, чем у нативных приложений       | Минимизация нативных зависимостей, оптимизация  |
| Зависимость от нативных модулей   | GPS и Bluetooth требуют глубокого интегрирования | Поддержка нескольких платформ, fallback решения |

---

# КОМПРОМИССЫ В АРХИТЕКТУРЕ

---

| Область                | Что выбрано                      | Альтернатива                     | Почему сделан компромисс                                | Чем жертвуем                                     |
| ---------------------- | -------------------------------- | -------------------------------- | ------------------------------------------------------- | ------------------------------------------------ |
| **Архитектура**        | MSA + Serverless                 | Только MSA или только Serverless | Микросервисы дают контроль, Serverless экономию         | Сложность управления разнородной инфраструктурой |
| **Базы данных**        | Разные типы под задачи           | Единая БД (PostgreSQL)           | Производительность и масштабируемость важнее унификации | Увеличенная сложность работы с данными           |
| **AI/ML**              | PyTorch + XGBoost                | TensorFlow Serving + SageMaker   | Гибкость экспериментов важнее production-ready решений  | Больше времени на deployment                     |
| **События**            | Apache Kafka                     | RabbitMQ / AWS SNS               | Нужна история событий и возможность replay              | Высокая стоимость эксплуатации Kafka             |
| **Фронтенд**           | React Native                     | Swift/Kotlin                     | Баланс скорости разработки и кроссплатформенности       | Зависимость от нативных модулей                  |
| **Безопасность**       | Собственная аутентификация       | Auth0 / Firebase Auth            | Кастомизация под бизнес-логику                          | Больше времени на поддержку                      |
| **Локализация данных** | Global catalog + regional shards | Centralized storage              | Соответствие GDPR/CCPA                                  | Сложность маршрутизации                          |
| **CI/CD**              | GitLab CI + Terraform            | AWS CodePipeline                 | Полный контроль над процессами                          | Настройка и поддержка                            |
| **Кэширование**        | Redis Cluster                    | Memcached                        | Поддержка persistence и sharding                        | Лицензирование и администрирование               |
| **Серверы**            | Multi-cloud стратегия            | Single cloud                     | Защита от региональных сбоев                            | Сложность управления, возможный vendor lock-in   |

---

# РИСКИ ПО АРХИТЕКТУРНЫМ АТРИБУТАМ КАЧЕСТВА

_(рассматриваем только критичные и высокие)_

## 1. Надежность

| Риск                    | Описание                            |
| ----------------------- | ----------------------------------- |
| Single point of failure | API Gateway, Event Bus без failover |
| Несогласованные данные  | Из-за CQRS и асинхронной репликации |
| Потеря событий          | При сбое Kafka или NATS JetStream   |

### Снижение:

- Geo-replication
- Circuit breakers
- Backup event logs

---

## 2. Масштабируемость

| Риск                                | Описание                              |
| ----------------------------------- | ------------------------------------- |
| Горизонтальная масштабируемость     | Не все сервисы легко масштабируются   |
| Hot partitions в БД                 | Одни shard'ы получают больше нагрузки |
| Сложность автоматического scale-out | Для stateful-сервисов                 |

### Снижение:

- Stateless design
- Auto-scaling policies
- Load testing перед пиками

---

## 3. Безопасность

| Риск                   | Описание                                  |
| ---------------------- | ----------------------------------------- |
| Утечка PII-данных      | Через неправильно настроенную авторизацию |
| Атаки на API Gateway   | DDoS, injection, auth bypass              |
| Несоблюдение GDPR/CCPA | При неправильной политике согласия        |

### Снижение:

- Zero Trust Architecture
- SIEM-система
- Регулярные пентесты

---

## 4. Производительность

| Риск                    | Описание                                |
| ----------------------- | --------------------------------------- |
| Cold Start в Serverless | Задержки при инференсе                  |
| Event Storming          | Перегрузка Kafka большим числом событий |
| Сложные JOIN-запросы    | В PostgreSQL при высокой нагрузке       |

### Снижение:

- Provisioned Concurrency
- Caching через Redis
- Partitioning и indexing

---

# РИСКИ ПО СЦЕНАРИЯМ ИСПОЛЬЗОВАНИЯ

## Сценарий: Пользователь завершает тренировку

| Риск                            | Описание                               |
| ------------------------------- | -------------------------------------- |
| Потеря события WorkoutCompleted | При сбое Kafka                         |
| Задержка в генерации достижения | При высокой загрузке AI Engine         |
| Ошибочные рекомендации          | Если модель не учла offline-тренировки |

### Снижение:

- Dead-letter queue
- Fallback logic
- Local event log

---

## Сценарий: Отправка push-уведомления

| Риск                     | Описание                      |
| ------------------------ | ----------------------------- |
| Долгие доставки          | Из-за очередей и backpressure |
| Потеря сообщений         | При сбое Push Provider        |
| Неправильная сегментация | Ошибочная рассылка            |

### Снижение:

- Message deduplication
- Retry mechanisms
- Feature flags для рассылок

---

## Сценарий: A/B тестирование маркетинговой акции

| Риск                   | Описание                             |
| ---------------------- | ------------------------------------ |
| Смещение метрик        | Из-за неправильного назначения групп |
| Утечка тестовых данных | В продакшен                          |
| Неявные зависимости    | Между параллельными тестами          |

### Снижение:

- Feature flags с clear segmentation
- Отдельные таблицы в ClickHouse
- Аудит перед запуском тестов

---

# СТОИМОСТЬ РИСКОВ И ROI ОТ ИХ СНИЖЕНИЯ

| Риск                             | Уровень воздействия | Вероятность | Стоимость риска | ROI от снижения риска                     |
| -------------------------------- | ------------------- | ----------- | --------------- | ----------------------------------------- |
| Vendor Lock-in                   | Medium              | High        | $200K+ в год    | Использование абстракций → ~$30K экономии |
| Сложность MSA                    | High                | Medium      | $350K+ в год    | Service Mesh + GitOps → ~$100K экономии   |
| Cold Start в Serverless          | Low                 | Medium      | $50K в год      | Provisioned concurrency → ~$10K           |
| Утечка данных                    | Critical            | Low         | $500K+ в год    | SIEM + Zero Trust → ~$200K защита         |
| Ошибочные AI-рекомендации        | Medium              | High        | $150K+ в год    | Аудит моделей → ~$50K экономии            |
| Конфликты данных в офлайн-режиме | Medium              | Medium      | $80K в год      | Conflict resolution → ~$30K экономии      |
