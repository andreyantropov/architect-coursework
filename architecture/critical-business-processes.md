# Критические бизнес-сценарии

## 1. Пользователь не может войти в систему
```plantuml
@startuml
|Пользователь|
start
:Отправить запрос на вход;
|API Gateway|
:Перенаправить запрос;
|Сервис "Пользователи и безопасность"|
:Ошибка входа;
|API Gateway|
:Перенаправить запрос;
|Пользователь|
:Получена ошибка авторизации;
stop
@enduml
```

## 2. Пользователь не может начать тренировку
```plantuml
@startuml
|Пользователь|
start
:Отправить запрос на тренировку;
|API Gateway|
:Перенаправить запрос;
|Сервис "Тренировки"|
:Сервис недоступен;
|API Gateway|
:Перенаправить запрос;
|Пользователь|
:Ошибка начала тренировки;
stop
@enduml
```

## 3. Лидерборды не обновляются
```plantuml
@startuml
|Сервис "Тренировки"|
start
:Завершить тренировку;
:Отправить данные о тренировке в Event Bus;

|Event Bus|
:Принять данные от сервиса "Тренировки";
:Перенаправить данные в сервис "Аналитика тренировок";

|Сервис "Аналитика тренировок"|
:Сервис недоступен;

|Пользователь|
:Открыть лидерборд;
:Данные не обновлены;
stop
@enduml
```

## 4. Регистрация нового пользователя
```plantuml
@startuml
|Пользователь|
start
:Запрос на регистрацию;
|API Gateway|
:Перенаправить запрос;
|Сервис "Пользователи"|
:Проверить email/телефон;
repeat
  :Email уже занят?;
  -> да;
  |API Gateway|
  :Вернуть ошибку;
  |Пользователь|
  :Получить ошибку регистрации;
repeat while (Повторная попытка) is (Новые данные)
-> нет;
:Создать пользователя;
:Генерировать верификацию;
|Внешний SMTP|
:Отправить письмо;
|Пользователь|
:Подтвердить email;
stop
@enduml
```

## 5. Интеграция с фитнес-устройством
```plantuml
@startuml
|Пользователь|
start
:Запрос на подключение устройства;
|API Gateway|
:Перенаправить запрос;
|Сервис "Тренировки"|
:Запросить доступ к API устройства;
|Внешний API устройства|
:Запрос авторизации;
|Пользователь|
:Подтвердить доступ;
|Сервис "Тренировки"|
:Сохранить токен доступа;
:Установить соединение;
fork
  :Начать сбор данных;
fork again
  |Пользователь|
  :Видеть данные в реальном времени;
end fork
stop
@enduml
```

## 6. Создание групповой тренировки
```plantuml
@startuml
|Пользователь|
start
:Создать групповую тренировку;
|API Gateway|
:Перенаправить запрос;
|Сервис "Социализация"|
:Проверить права;
:Создать событие;
|Event Bus|
:Опубликовать событие;
|Сервис "Уведомления"|
:Разослать приглашения;
|Пользователи группы|
:Получить уведомления;
stop
@enduml
```

## 7. Обработка промоакций
```plantuml
@startuml
|Администратор|
start
:Создать промоакцию;
|Сервис "Промоакции"|
:Сохранить в БД;
|Event Bus|
:Опубликовать событие;
|Сервис "Рекомендации"|
:Сгенерировать персональные предложения;
|Сервис "Пользователи"|
:Фильтр по региону;
|Пользователь|
:Получить персонализированную промоакцию;
:Купить товар со скидкой;
stop
@enduml
```

## 8. Восстановление пароля
```plantuml
@startuml
|Пользователь|
start
:Запрос на восстановление;
|API Gateway|
:Перенаправить запрос;
|Сервис "Пользователи"|
:Найти по email/телефону;
:Сгенерировать токен;
|Внешний SMTP/SMS|
:Отправить ссылку;
|Пользователь|
:Перейти по ссылке;
|Сервис "Пользователи"|
:Проверить токен;
:Обновить пароль;
stop
@enduml
```

## 9. Синхронизация с соц. сетями
```plantuml
@startuml
|Пользователь|
start
:Запрос на привязку соцсети;
|API Gateway|
:Перенаправить запрос;
|Сервис "Пользователи"|
:Перенаправить в OAuth провайдера;
|Провайдер (Facebook/Google)|
:Запрос авторизации;
|Пользователь|
:Подтвердить доступ;
|Сервис "Пользователи"|
:Получить данные профиля;
:Связать аккаунты;
|Сервис "Социализация"|
:Импорт друзей;
stop
@enduml
```